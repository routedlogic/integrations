---
description: Pipeline for mapping BBOT fields to ECS

processors:

# NOTE: ALWAYS use set, do NOT use rename. Duplicated fields are removed in the main pipeline *IF* the tag preserve_duplicate_custom_fields has not been provided.

##############################################################
# https://www.elastic.co/guide/en/ecs/current/ecs-event.html #
##############################################################

- append:
    field: event.category
    value: network
    allow_duplicates: false
    media_type: text/plain

- append:
    field: event.type
    value: info
    allow_duplicates: false
    media_type: text/plain

#############################################################
# https://www.elastic.co/guide/en/ecs/current/ecs-host.html #
#############################################################

- set:
    if: ctx.bbot?.data?.DNS_NAME != null
    copy_from: bbot.data.DNS_NAME
    field: host.name
    ignore_empty_value: true

- append:
    field: host.ip
    value: '{{{bbot.data.IP_ADDRESS}}}'
    if: ctx.bbot?.data?.IP_ADDRESS != null

################################################################
# https://www.elastic.co/guide/en/ecs/current/ecs-related.html #
################################################################

- set:
    if: ctx.bbot?.resolved_hosts != null
    copy_from: bbot.resolved_hosts
    field: related.hosts
    ignore_empty_value: true

############################################################
# https://www.elastic.co/guide/en/ecs/current/ecs-url.html #
############################################################

- set:
    if: ctx.bbot?.data?.PROTOCOL?.port != null
    copy_from: bbot.data.PROTOCOL.port
    field: url.port
    ignore_empty_value: true

- append:
    field: url.full 
    value: '{{{bbot.data.URL}}}'
    if: ctx.bbot?.data?.URL != null
    allow_duplicates: false

- append:
    field: url.full
    value: '{{{bbot.data.FINDING.url}}}'
    if: ctx.bbot?.data?.FINDING?.url != null
    allow_duplicates: false

- append:
    field: url.full
    value: '{{{bbot.data.SOCIAL.url}}}'
    if: ctx.bbot?.data?.SOCIAL?.url != null
    allow_duplicates: false

- append:
    field: url.full
    value: '{{{bbot.data.STORAGE_BUCKET.url}}}'
    if: ctx.bbot?.data?.STORAGE_BUCKET?.url != null
    allow_duplicates: false

- append:
    field: url.full
    value: '{{{bbot.data.TECHNOLOGY.url}}}'
    if: ctx.bbot?.data?.TECHNOLOGY?.url != null
    allow_duplicates: false

- append:
    field: url.full
    value: '{{{bbot.data.VULNERABILITY.url}}}'
    if: ctx.bbot?.data?.VULNERABILITY?.url != null
    allow_duplicates: false

- append:
    field: url.full
    value: '{{{bbot.data.WAF.url}}}'
    if: ctx.bbot?.data?.WAF?.url != null
    allow_duplicates: false

- append:
    field: url.full
    value: '{{{bbot.data.WEBSCREENSHOT.url}}}'
    if: ctx.bbot?.data?.WEBSCREENSHOT?.url != null
    allow_duplicates: false

- append:
    field: url.domain 
    value: '{{{bbot.data.FINDING.host}}}'
    if: ctx.bbot?.data?.FINDING?.host != null
    allow_duplicates: false

- append:
    field: url.domain 
    value: '{{{bbot.data.PROTOCOL.host}}}'
    if: ctx.bbot?.data?.PROTOCOL?.host != null
    allow_duplicates: false

- append:
    field: url.domain 
    value: '{{{bbot.data.TECHNOLOGY.host}}}'
    if: ctx.bbot?.data?.TECHNOLOGY?.host != null
    allow_duplicates: false

- append:
    field: url.domain 
    value: '{{{bbot.data.VULNERABILITY.host}}}'
    if: ctx.bbot?.data?.VULNERABILITY?.host != null
    allow_duplicates: false

- append:
    field: url.domain 
    value: '{{{bbot.data.WAF.host}}}'
    if: ctx.bbot?.data?.WAF?.host != null
    allow_duplicates: false

- append:
    field: url.domain 
    value: '{{{host.name}}}'
    if: ctx.host?.name != null
    allow_duplicates: false

######################################################################
# https://www.elastic.co/guide/en/ecs/current/ecs-vulnerability.html #
######################################################################

- set:
    if: ctx.bbot?.data?.VULNERABILITY?.severity != null
    copy_from: bbot.data.VULNERABILITY.severity
    field: vulnerability.severity
    ignore_empty_value: true

#############
# Fix Stuff #
#############

# Uppercase field names will probably work, but it goes against ECS, lowercase 'em
- foreach:
    description: Lowercase the first level field under bbot.data, e.g. DNS_NAME becomes dns_name
    tag: data_event_lowercase
    field: bbot.data
    if: ctx.bbot?.data != null
    ignore_missing: true
    processor: 
      lowercase:
        field: "_ingest._key"

# EOF
